{% extends "base.html" %}

{% block content %}
<div class="header">
    <h1>üõ°Ô∏è Advanced Boundary Mastery Program</h1>
    <p>21-Day Interactive Boundary Building Journey</p>
</div>

<!-- Progress Overview -->
<div class="card" style="margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #ffffff; margin: 0;">Your Progress</h2>
        <div style="background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); padding: 10px 20px; border-radius: 25px;">
            <span style="color: #ffffff; font-weight: bold;">Day 1 of 21</span>
        </div>
    </div>
    
    <div style="background: #2d3436; border-radius: 10px; height: 20px; margin-bottom: 15px; overflow: hidden;">
        <div style="background: linear-gradient(135deg, #00b894 0%, #74b9ff 100%); height: 100%; width: 5%; transition: width 0.3s ease;"></div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div style="text-align: center;">
            <span style="color: #00b894; font-size: 1.5rem; font-weight: bold;">0/7</span>
            <p style="color: #ffffff; margin: 5px 0 0; font-size: 0.9rem;">Week 1 Complete</p>
        </div>
        <div style="text-align: center;">
            <span style="color: #74b9ff; font-size: 1.5rem; font-weight: bold;">3</span>
            <p style="color: #ffffff; margin: 5px 0 0; font-size: 0.9rem;">Boundaries Set</p>
        </div>
        <div style="text-align: center;">
            <span style="color: #fdcb6e; font-size: 1.5rem; font-weight: bold;">85%</span>
            <p style="color: #ffffff; margin: 5px 0 0; font-size: 0.9rem;">Success Rate</p>
        </div>
    </div>
</div>

<!-- Daily Challenge -->
<div class="card" style="background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%); margin-bottom: 20px;">
    <h2 style="color: #ffffff; margin-bottom: 20px; text-align: center;">üî• Today's Challenge</h2>
    <div style="text-align: center;">
        <h3 style="color: #ffffff; margin-bottom: 15px;">Boundary Assessment & Personal Inventory</h3>
        <p style="color: #ffffff; margin-bottom: 20px; line-height: 1.6;">
            Complete your personalized boundary assessment to identify your strongest and weakest boundary areas.
        </p>
        <button onclick="startAssessment()" class="btn" style="background: #ffffff; color: #e84393; font-weight: bold;">
            üéØ Start Assessment (10 min)
        </button>
    </div>
</div>

<!-- Interactive Assessment Modal -->
<div id="assessmentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 20px; padding: 30px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="color: #ffffff; margin: 0;">Boundary Assessment</h2>
            <button onclick="closeAssessment()" style="background: none; border: none; color: #ffffff; font-size: 1.5rem; cursor: pointer;">‚úï</button>
        </div>
        
        <div id="assessmentContent">
            <div class="assessment-question" data-question="1" style="display: block;">
                <h3 style="color: #74b9ff; margin-bottom: 15px;">Question 1 of 12</h3>
                <p style="color: #ffffff; margin-bottom: 20px; line-height: 1.6;">
                    How often do you say "yes" to requests when you'd rather say "no"?
                </p>
                <div style="display: grid; gap: 10px;">
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="radio" name="q1" value="1" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Almost never - I'm comfortable saying no</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="radio" name="q1" value="2" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Sometimes - depends on the situation</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="radio" name="q1" value="3" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Often - I struggle with saying no</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                        <input type="radio" name="q1" value="4" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Almost always - I can't say no</span>
                    </label>
                </div>
            </div>
            
            <div class="assessment-question" data-question="2" style="display: none;">
                <h3 style="color: #74b9ff; margin-bottom: 15px;">Question 2 of 12</h3>
                <p style="color: #ffffff; margin-bottom: 20px; line-height: 1.6;">
                    How do you feel when someone gets upset about a boundary you've set?
                </p>
                <div style="display: grid; gap: 10px;">
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q2" value="1" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Confident - their reaction is about them, not me</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q2" value="2" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Uncomfortable but I maintain the boundary</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q2" value="3" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Guilty and likely to give in</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q2" value="4" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Anxious and immediately apologize/backtrack</span>
                    </label>
                </div>
            </div>
            
            <div class="assessment-question" data-question="3" style="display: none;">
                <h3 style="color: #74b9ff; margin-bottom: 15px;">Question 3 of 12</h3>
                <p style="color: #ffffff; margin-bottom: 20px; line-height: 1.6;">
                    How often do you check work emails or take work calls outside of business hours?
                </p>
                <div style="display: grid; gap: 10px;">
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q3" value="1" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Never - work stays at work</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q3" value="2" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Rarely - only true emergencies</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q3" value="3" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Often - I feel pressure to be available</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q3" value="4" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Constantly - I'm always "on"</span>
                    </label>
                </div>
            </div>
            
            <div class="assessment-question" data-question="4" style="display: none;">
                <h3 style="color: #74b9ff; margin-bottom: 15px;">Question 4 of 12</h3>
                <p style="color: #ffffff; margin-bottom: 20px; line-height: 1.6;">
                    When someone asks for personal information you'd rather not share, you:
                </p>
                <div style="display: grid; gap: 10px;">
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q4" value="1" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Politely decline to share</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q4" value="2" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Change the subject</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q4" value="3" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Share reluctantly to avoid conflict</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q4" value="4" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Share everything they ask about</span>
                    </label>
                </div>
            </div>
            
            <div class="assessment-question" data-question="5" style="display: none;">
                <h3 style="color: #74b9ff; margin-bottom: 15px;">Question 5 of 12</h3>
                <p style="color: #ffffff; margin-bottom: 20px; line-height: 1.6;">
                    How do you handle it when someone repeatedly cancels plans with you?
                </p>
                <div style="display: grid; gap: 10px;">
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q5" value="1" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Address it directly and set expectations</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q5" value="2" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Stop making plans with them</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q5" value="3" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Keep making plans hoping they'll change</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q5" value="4" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Always accommodate their schedule</span>
                    </label>
                </div>
            </div>
            
            <div class="assessment-question" data-question="6" style="display: none;">
                <h3 style="color: #74b9ff; margin-bottom: 15px;">Question 6 of 12</h3>
                <p style="color: #ffffff; margin-bottom: 20px; line-height: 1.6;">
                    When you're feeling overwhelmed, you typically:
                </p>
                <div style="display: grid; gap: 10px;">
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q6" value="1" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Take time for yourself without guilt</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q6" value="2" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Ask others for help or support</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q6" value="3" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Push through and keep helping others</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q6" value="4" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Feel guilty for being overwhelmed</span>
                    </label>
                </div>
            </div>
            
            <div class="assessment-question" data-question="7" style="display: none;">
                <h3 style="color: #74b9ff; margin-bottom: 15px;">Question 7 of 12</h3>
                <p style="color: #ffffff; margin-bottom: 20px; line-height: 1.6;">
                    How comfortable are you with disappointing others?
                </p>
                <div style="display: grid; gap: 10px;">
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q7" value="1" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Very comfortable - it's necessary sometimes</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q7" value="2" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Somewhat comfortable when it's important</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q7" value="3" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Uncomfortable but do it when necessary</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q7" value="4" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Very uncomfortable - avoid it at all costs</span>
                    </label>
                </div>
            </div>
            
            <div class="assessment-question" data-question="8" style="display: none;">
                <h3 style="color: #74b9ff; margin-bottom: 15px;">Question 8 of 12</h3>
                <p style="color: #ffffff; margin-bottom: 20px; line-height: 1.6;">
                    When someone criticizes your boundaries, you:
                </p>
                <div style="display: grid; gap: 10px;">
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q8" value="1" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Stand firm and explain your reasoning</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q8" value="2" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Listen but maintain your boundary</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q8" value="3" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Question yourself and consider changing</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q8" value="4" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Immediately give in to avoid conflict</span>
                    </label>
                </div>
            </div>
            
            <div class="assessment-question" data-question="9" style="display: none;">
                <h3 style="color: #74b9ff; margin-bottom: 15px;">Question 9 of 12</h3>
                <p style="color: #ffffff; margin-bottom: 20px; line-height: 1.6;">
                    How do you handle requests for favors when you're already busy?
                </p>
                <div style="display: grid; gap: 10px;">
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q9" value="1" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Politely decline and suggest alternatives</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q9" value="2" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Explain your situation and set a later time</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q9" value="3" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Say yes but feel resentful</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q9" value="4" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Always say yes regardless of your schedule</span>
                    </label>
                </div>
            </div>
            
            <div class="assessment-question" data-question="10" style="display: none;">
                <h3 style="color: #74b9ff; margin-bottom: 15px;">Question 10 of 12</h3>
                <p style="color: #ffffff; margin-bottom: 20px; line-height: 1.6;">
                    When someone makes you uncomfortable with inappropriate comments, you:
                </p>
                <div style="display: grid; gap: 10px;">
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q10" value="1" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Address it immediately and clearly</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q10" value="2" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Remove yourself from the situation</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q10" value="3" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Feel uncomfortable but say nothing</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q10" value="4" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Laugh along to avoid confrontation</span>
                    </label>
                </div>
            </div>
            
            <div class="assessment-question" data-question="11" style="display: none;">
                <h3 style="color: #74b9ff; margin-bottom: 15px;">Question 11 of 12</h3>
                <p style="color: #ffffff; margin-bottom: 20px; line-height: 1.6;">
                    How do you feel about asking others to respect your needs?
                </p>
                <div style="display: grid; gap: 10px;">
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q11" value="1" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Natural and necessary</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q11" value="2" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Somewhat comfortable when it's important</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q11" value="3" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Difficult but sometimes necessary</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q11" value="4" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Selfish and wrong</span>
                    </label>
                </div>
            </div>
            
            <div class="assessment-question" data-question="12" style="display: none;">
                <h3 style="color: #74b9ff; margin-bottom: 15px;">Question 12 of 12</h3>
                <p style="color: #ffffff; margin-bottom: 20px; line-height: 1.6;">
                    When you set a boundary and someone ignores it, you:
                </p>
                <div style="display: grid; gap: 10px;">
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q12" value="1" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Enforce consequences consistently</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q12" value="2" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Remind them firmly of the boundary</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q12" value="3" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Feel frustrated but don't enforce it</span>
                    </label>
                    <label class="assessment-option" style="background: #2d3436; padding: 15px; border-radius: 10px; cursor: pointer;">
                        <input type="radio" name="q12" value="4" style="margin-right: 10px;">
                        <span style="color: #ffffff;">Assume they forgot and let it slide</span>
                    </label>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                <button onclick="previousQuestion()" id="prevBtn" style="background: #636e72; color: #ffffff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; display: none;">
                    ‚Üê Previous
                </button>
                <button onclick="nextQuestion()" id="nextBtn" style="background: #74b9ff; color: #ffffff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    Next ‚Üí
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div id="resultsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1001;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 20px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
        <div id="assessmentResults"></div>
    </div>
</div>

<!-- Program Overview -->
<div class="card">
    <h2 style="text-align: center; margin-bottom: 30px; color: #ffffff;">21-Day Program Structure</h2>
    
    <div style="display: grid; gap: 20px;">
        <!-- Week 1 -->
        <div style="background: linear-gradient(135deg, #00b894 0%, #00a085 100%); border-radius: 15px; padding: 25px;">
            <h3 style="color: #ffffff; margin-bottom: 20px; display: flex; align-items: center;">
                <span style="background: #ffffff; color: #00b894; padding: 5px 15px; border-radius: 20px; margin-right: 15px; font-weight: bold;">Week 1</span>
                Foundation & Assessment
            </h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                    <h4 style="color: #ffffff; margin-bottom: 10px;">Day 1-2: Assessment</h4>
                    <p style="color: #ffffff; margin: 0; font-size: 0.9rem;">Personal boundary inventory & strength analysis</p>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                    <h4 style="color: #ffffff; margin-bottom: 10px;">Day 3-4: Identification</h4>
                    <p style="color: #ffffff; margin: 0; font-size: 0.9rem;">Recognize boundary violations & triggers</p>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                    <h4 style="color: #ffffff; margin-bottom: 10px;">Day 5-7: Planning</h4>
                    <p style="color: #ffffff; margin: 0; font-size: 0.9rem;">Create your personalized boundary blueprint</p>
                </div>
            </div>
        </div>
        
        <!-- Week 2 -->
        <div style="background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); border-radius: 15px; padding: 25px;">
            <h3 style="color: #ffffff; margin-bottom: 20px; display: flex; align-items: center;">
                <span style="background: #ffffff; color: #0984e3; padding: 5px 15px; border-radius: 20px; margin-right: 15px; font-weight: bold;">Week 2</span>
                Implementation & Practice
            </h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                    <h4 style="color: #ffffff; margin-bottom: 10px;">Day 8-10: Communication</h4>
                    <p style="color: #ffffff; margin: 0; font-size: 0.9rem;">Master boundary-setting conversations</p>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                    <h4 style="color: #ffffff; margin-bottom: 10px;">Day 11-12: Practice</h4>
                    <p style="color: #ffffff; margin: 0; font-size: 0.9rem;">Real-world boundary implementation</p>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                    <h4 style="color: #ffffff; margin-bottom: 10px;">Day 13-14: Adjustment</h4>
                    <p style="color: #ffffff; margin: 0; font-size: 0.9rem;">Refine based on feedback & results</p>
                </div>
            </div>
        </div>
        
        <!-- Week 3 -->
        <div style="background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%); border-radius: 15px; padding: 25px;">
            <h3 style="color: #ffffff; margin-bottom: 20px; display: flex; align-items: center;">
                <span style="background: #ffffff; color: #e84393; padding: 5px 15px; border-radius: 20px; margin-right: 15px; font-weight: bold;">Week 3</span>
                Mastery & Integration
            </h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                    <h4 style="color: #ffffff; margin-bottom: 10px;">Day 15-17: Advanced</h4>
                    <p style="color: #ffffff; margin: 0; font-size: 0.9rem;">Handle pushback & difficult scenarios</p>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                    <h4 style="color: #ffffff; margin-bottom: 10px;">Day 18-20: Integration</h4>
                    <p style="color: #ffffff; margin: 0; font-size: 0.9rem;">Make boundaries automatic habits</p>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                    <h4 style="color: #ffffff; margin-bottom: 10px;">Day 21: Mastery</h4>
                    <p style="color: #ffffff; margin: 0; font-size: 0.9rem;">Final assessment & future planning</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Interactive Tools -->
<div class="card">
    <h2 style="text-align: center; margin-bottom: 30px; color: #ffffff;">Interactive Tools & Features</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
        <div data-section="boundary-tracker" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #74b9ff; border-radius: 15px; padding: 25px; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 15px;">üìä</div>
            <h3 style="color: #74b9ff; margin-bottom: 15px;">Boundary Tracker</h3>
            <p style="color: #ffffff; margin-bottom: 20px; line-height: 1.6;">
                Daily tracking of boundary successes, challenges, and emotional responses with visual progress charts.
            </p>
            <button onclick="openTracker()" class="btn">Open Tracker</button>
        </div>
        
        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #fdcb6e; border-radius: 15px; padding: 25px; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 15px;">üßò</div>
            <h3 style="color: #fdcb6e; margin-bottom: 15px;">Confidence Builder</h3>
            <p style="color: #ffffff; margin-bottom: 20px; line-height: 1.6;">
                Guided visualization and affirmation exercises to build confidence in boundary-setting situations.
            </p>
            <button onclick="openConfidenceBuilder()" class="btn">Build Confidence</button>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card" style="background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);">
    <h3 style="color: #74b9ff; margin-bottom: 20px; text-align: center;">Quick Actions</h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
        <button onclick="dailyReflection()" class="btn btn-secondary" style="display: flex; align-items: center; justify-content: center; gap: 10px;">
            <span style="font-size: 1.2rem;">üí≠</span>
            Daily Reflection
        </button>
        <button onclick="viewProgressHistory()" class="btn" style="display: flex; align-items: center; justify-content: center; gap: 10px; background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);">
            <span style="font-size: 1.2rem;">üìä</span>
            View Progress
        </button>
    </div>
</div>

<div style="text-align: center; margin-top: 30px;">
    <a href="{{ url_for('situationship_mode') }}" class="btn btn-secondary">üè† Back to Situationship Mode</a>
</div>

<style>
.assessment-option:hover {
    background: #74b9ff !important;
    transform: translateY(-2px);
}

.assessment-option input:checked + span {
    font-weight: bold;
}

.btn {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    border: none;
    color: white;
    padding: 12px 24px;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(116, 185, 255, 0.3);
}

.btn-secondary {
    background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);
}
</style>

<script>
let currentQuestion = 1;
const totalQuestions = 12;
const assessmentAnswers = {};

function startAssessment() {
    document.getElementById('assessmentModal').style.display = 'block';
    currentQuestion = 1;
    showQuestion(1);
}

function closeAssessment() {
    document.getElementById('assessmentModal').style.display = 'none';
}

function showQuestion(questionNum) {
    // Hide all questions
    document.querySelectorAll('.assessment-question').forEach(q => {
        q.style.display = 'none';
    });
    
    // Show current question
    const currentQ = document.querySelector(`[data-question="${questionNum}"]`);
    if (currentQ) {
        currentQ.style.display = 'block';
    }
    
    // Update navigation buttons
    document.getElementById('prevBtn').style.display = questionNum === 1 ? 'none' : 'block';
    document.getElementById('nextBtn').textContent = questionNum === totalQuestions ? 'Complete Assessment' : 'Next ‚Üí';
}

function nextQuestion() {
    // Save current answer
    const currentInput = document.querySelector(`input[name="q${currentQuestion}"]:checked`);
    if (!currentInput) {
        alert('Please select an answer before continuing.');
        return;
    }
    
    assessmentAnswers[`q${currentQuestion}`] = currentInput.value;
    
    if (currentQuestion < totalQuestions) {
        currentQuestion++;
        showQuestion(currentQuestion);
    } else {
        completeAssessment();
    }
}

function previousQuestion() {
    if (currentQuestion > 1) {
        currentQuestion--;
        showQuestion(currentQuestion);
    }
}

function completeAssessment() {
    // Process assessment results
    const totalScore = Object.values(assessmentAnswers).reduce((sum, val) => sum + parseInt(val), 0);
    const maxScore = 48; // 12 questions √ó 4 max points
    const strengthScore = Math.round((1 - (totalScore - 12) / 36) * 100);
    
    // Show personalized results modal
    showAssessmentResults(strengthScore, assessmentAnswers);
    closeAssessment();
    
    // Update progress
    updateProgress();
}

function showAssessmentResults(score, answers) {
    let resultText = '';
    let recommendations = [];
    
    if (score >= 80) {
        resultText = 'Strong Boundary Setter! You have excellent boundary skills.';
        recommendations = [
            'Focus on helping others develop boundary skills',
            'Practice advanced boundary scenarios',
            'Work on maintaining boundaries under extreme pressure'
        ];
    } else if (score >= 60) {
        resultText = 'Good Foundation! You have solid boundary skills with room to grow.';
        recommendations = [
            'Practice saying no in low-stakes situations',
            'Work on emotional boundaries with family/friends',
            'Develop scripts for difficult conversations'
        ];
    } else if (score >= 40) {
        resultText = 'Building Blocks! You understand boundaries but need practice implementing them.';
        recommendations = [
            'Start with one small boundary this week',
            'Practice boundary phrases in the mirror',
            'Focus on time boundaries first'
        ];
    } else {
        resultText = 'Foundation Building! You\'re just starting your boundary journey.';
        recommendations = [
            'Begin with identifying where you need boundaries',
            'Practice self-care without guilt',
            'Start with boundaries in less important relationships'
        ];
    }
    
    document.getElementById('assessmentResults').innerHTML = `
        <div style="text-align: center; padding: 30px;">
            <h2 style="color: #74b9ff; margin-bottom: 20px;">Your Boundary Strength: ${score}%</h2>
            <p style="color: #ffffff; font-size: 1.2rem; margin-bottom: 30px;">${resultText}</p>
            
            <div style="background: #2d3436; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: left;">
                <h3 style="color: #00b894; margin-bottom: 15px;">Personalized Recommendations:</h3>
                <ul style="color: #ffffff; line-height: 1.8;">
                    ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            </div>
            
            <button onclick="startProgram()" class="btn" style="margin-right: 15px;">
                üöÄ Start My 21-Day Journey
            </button>
            <button onclick="closeResults()" class="btn btn-secondary">
                üìä View Detailed Analysis
            </button>
        </div>
    `;
    document.getElementById('resultsModal').style.display = 'block';
}

function startProgram() {
    // Redirect to actual Day 1 of program
    window.location.href = '/boundary-program/day/1';
}

function closeResults() {
    document.getElementById('resultsModal').style.display = 'none';
}

// Interactive tool functions - Real functionality
function openTracker() {
    showModal('Boundary Tracker', `
        <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
            <h3 style="color: #74b9ff; margin-bottom: 20px;">Today's Boundary Tracking</h3>
            
            <div style="margin-bottom: 20px;">
                <label style="color: #ffffff; display: block; margin-bottom: 10px;">How many times did you successfully maintain a boundary today?</label>
                <input type="number" id="boundaryCount" min="0" max="20" style="width: 100%; padding: 10px; border-radius: 5px; border: none;">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="color: #ffffff; display: block; margin-bottom: 10px;">How confident did you feel setting boundaries? (1-10)</label>
                <input type="range" id="confidenceLevel" min="1" max="10" value="5" style="width: 100%;">
                <div style="color: #74b9ff; text-align: center;" id="confidenceDisplay">5</div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="color: #ffffff; display: block; margin-bottom: 10px;">What boundary challenge did you face today?</label>
                <textarea id="boundaryChallenge" style="width: 100%; height: 80px; padding: 10px; border-radius: 5px; border: none;" placeholder="Describe your biggest boundary challenge today..."></textarea>
            </div>
            
            <button onclick="saveBoundaryData()" class="btn" style="margin-bottom: 30px;">Save Progress</button>
            
            <!-- Progress History Section -->
            <div style="border-top: 2px solid #74b9ff; padding-top: 20px;">
                <h4 style="color: #74b9ff; margin-bottom: 15px;">üìä Your Progress History</h4>
                <div id="progressHistory" style="max-height: 200px; overflow-y: auto;">
                    <!-- Progress entries will appear here -->
                </div>
                <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #2d3436 0%, #636e72 100%); border-radius: 10px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                        <div>
                            <div style="color: #00b894; font-size: 1.2rem; font-weight: bold;" id="totalBoundaries">0</div>
                            <div style="color: #ffffff; font-size: 0.8rem;">Total Boundaries</div>
                        </div>
                        <div>
                            <div style="color: #74b9ff; font-size: 1.2rem; font-weight: bold;" id="avgConfidence">0</div>
                            <div style="color: #ffffff; font-size: 0.8rem;">Avg Confidence</div>
                        </div>
                        <div>
                            <div style="color: #fdcb6e; font-size: 1.2rem; font-weight: bold;" id="streakDays">0</div>
                            <div style="color: #ffffff; font-size: 0.8rem;">Day Streak</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Visualization History Section -->
            <div style="border-top: 2px solid #74b9ff; margin-top: 30px; padding-top: 20px;">
                <h4 style="color: #74b9ff; margin-bottom: 15px;">üßò Your Visualization History</h4>
                <div id="visualizationHistory" style="max-height: 200px; overflow-y: auto;">
                    <!-- Visualization entries will appear here -->
                </div>
            </div>
        </div>
    `);
    
    // Add event listener for confidence slider
    setTimeout(() => {
        document.getElementById('confidenceLevel').addEventListener('input', function() {
            document.getElementById('confidenceDisplay').textContent = this.value;
        });
        
        // Load and display existing progress
        loadProgressHistory();
        
        // Load and display visualization history
        loadVisualizationHistory();
    }, 100);
}

function openSimulator() {
    // First, remove any existing simulator modal to prevent duplicates
    const existingModal = document.getElementById('scenarioSimulatorModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Create the scenario simulator modal HTML directly without using showModal
    const modal = document.createElement('div');
    modal.id = 'scenarioSimulatorModal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;';
    
    // Define scenario descriptions
    const scenarios = {
        work: "Your boss asks you to take on an extra project when you're already at capacity. You need to set a boundary about your workload.",
        family: "A family member constantly shows up at your house unannounced and expects you to drop everything to spend time with them.",
        friend: "Your friend constantly shares intimate details about their life and expects the same from you, but you're not comfortable with this level of sharing.",
        romantic: "Someone you're dating is moving things forward physically faster than you're comfortable with.",
        money: "A friend or family member repeatedly asks to borrow money and rarely pays you back."
    };
    
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 20px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #333;">
                <h2 style="color: #ffffff; margin: 0;">Scenario Simulator</h2>
                <button onclick="document.getElementById('scenarioSimulatorModal').remove()" style="background: none; border: none; color: #ffffff; font-size: 1.5rem; cursor: pointer;">‚úï</button>
            </div>
            
            <div style="padding: 20px;">
                <h3 style="color: #74b9ff; margin-bottom: 20px;">Practice Boundary Conversations</h3>
                
                <div style="margin-bottom: 20px;">
                    <label style="color: #ffffff; display: block; margin-bottom: 10px;">Choose a scenario to practice:</label>
                    <select id="scenarioSelect" style="width: 100%; padding: 10px; border-radius: 5px; border: none;">
                        <option value="work">Saying no to extra work</option>
                        <option value="family">Setting limits with family</option>
                        <option value="friend">Friend who overshares</option>
                        <option value="romantic">Dating boundaries</option>
                        <option value="money">Money requests</option>
                    </select>
                </div>
                
                <div id="scenarioContent" style="background: #2d3436; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="color: #ffffff;">
                        <strong>Scenario:</strong> ${scenarios.work}
                    </p>
                </div>
                
                <button id="startSessionBtn" style="background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%;">Start Practice Session</button>
            </div>
        </div>
    `;
    
    // Append the modal to the document
    document.body.appendChild(modal);
    
    // Wait for the DOM to be updated before attaching event listeners
    setTimeout(() => {
        // Add event listener for scenario selection
        const scenarioSelect = document.getElementById('scenarioSelect');
        const scenarioContent = document.getElementById('scenarioContent');
        
        if (scenarioSelect && scenarioContent) {
            scenarioSelect.addEventListener('change', function() {
                // Add transition effect
                scenarioContent.style.opacity = '0';
                
                setTimeout(() => {
                    scenarioContent.innerHTML = `
                        <p style="color: #ffffff; margin-bottom: 15px;">
                            <strong>Scenario:</strong> ${scenarios[this.value]}
                        </p>
                    `;
                    
                    scenarioContent.style.opacity = '1';
                    scenarioContent.style.transition = 'opacity 0.3s ease';
                }, 200);
            });
        } else {
            console.error('Scenario select or content elements not found');
        }
        
        // Add event listener for start button
        const startBtn = document.getElementById('startSessionBtn');
        if (startBtn) {
            startBtn.addEventListener('click', function() {
                // Get the selected scenario type before closing the modal
                const scenarioType = document.getElementById('scenarioSelect')?.value || 'work';
                
                // Close this modal
                modal.remove();
                
                // Start the scenario practice with the selected type
                startScenario(scenarioType);
                
                // Show toast notification
                showToast('üéÆ Practice Session Started', 'Practice your boundary-setting skills in this scenario.', 'info');
            });
        } else {
            console.error('Start session button not found');
        }
    }, 50); // Short delay to ensure DOM is ready
}

function startScenario(scenarioType) {
    // Default to 'work' if no type is provided
    if (!scenarioType) {
        scenarioType = 'work';
    }
    
    // First, remove any existing practice session modal
    const existingModal = document.getElementById('scenarioPracticeModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Define responses and challenges by scenario type
    const scenarios = {
        work: {
            title: "Workplace Boundary Practice",
            context: "Your boss approaches you with another urgent project when you're already working on three others.",
            challenge: "Set a boundary without risking your professional reputation."
        },
        family: {
            title: "Family Boundary Practice",
            context: "Your mother shows up unannounced at your apartment for the third time this week.",
            challenge: "Set a boundary while maintaining the relationship."
        },
        friend: {
            title: "Friendship Boundary Practice",
            context: "Your friend is sharing extremely personal details and expects you to do the same.",
            challenge: "Set a privacy boundary without making them feel rejected."
        },
        romantic: {
            title: "Dating Boundary Practice",
            context: "Your date is moving physically faster than you're comfortable with.",
            challenge: "Set a physical boundary clearly while preserving the connection."
        },
        money: {
            title: "Financial Boundary Practice",
            context: "Your sibling asks to borrow money again, despite not having paid back previous loans.",
            challenge: "Set a financial boundary firmly but compassionately."
        }
    };
    
    // Default to work scenario if the selected type isn't found
    const scenario = scenarios[scenarioType] || scenarios.work;
    
    // Create the practice session modal HTML
    const modal = document.createElement('div');
    modal.id = 'scenarioPracticeModal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;';
    
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 20px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #333;">
                <h2 style="color: #ffffff; margin: 0;">${scenario.title}</h2>
                <button onclick="document.getElementById('scenarioPracticeModal').remove()" style="background: none; border: none; color: #ffffff; font-size: 1.5rem; cursor: pointer;">‚úï</button>
            </div>
            
            <div style="padding: 20px;">
                <div style="background: linear-gradient(135deg, #2d3436 0%, #636e72 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="color: #ffffff; margin-bottom: 10px;"><strong>Context:</strong> ${scenario.context}</p>
                    <p style="color: #74b9ff;"><strong>Your Challenge:</strong> ${scenario.challenge}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #74b9ff; margin-bottom: 10px;">Practice Your Response:</h4>
                    <textarea id="scenarioPracticeResponse" style="width: 100%; height: 120px; padding: 15px; border-radius: 8px; border: none; margin-bottom: 15px;" placeholder="Type how you would respond in this situation..."></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <button id="getFeedbackBtn" style="background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        Get Feedback
                    </button>
                    <button onclick="endPracticeSession('${scenarioType}')" style="background: linear-gradient(135deg, #636e72 0%, #2d3436 100%); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer;">
                        End Session
                    </button>
                </div>
                
                <div id="scenarioPracticeFeedback" style="margin-top: 20px; display: none; background: #16213e; padding: 15px; border-radius: 8px; border-left: 4px solid #00b894;"></div>
            </div>
        </div>
    `;
    
    // Append the modal to the document
    document.body.appendChild(modal);
    
    // Ensure the modal is fully in the DOM before attaching event listeners
    setTimeout(() => {
        // Ensure the feedback button exists in the DOM before attaching event listener
        const feedbackBtn = document.getElementById('getFeedbackBtn');
        if (!feedbackBtn) {
            console.error('Feedback button not found in the DOM');
            return;
        }
        
        feedbackBtn.addEventListener('click', function() {
            // Get the response text
            const responseText = document.getElementById('scenarioPracticeResponse').value.trim();
            const feedbackDiv = document.getElementById('scenarioPracticeFeedback');
            
            if (!feedbackDiv) {
                console.error('Feedback div not found');
                return;
            }
            
            if (!responseText) {
                feedbackDiv.innerHTML = `
                    <p style="color: #e17055; margin-bottom: 10px;">Please enter your response first.</p>
                `;
                feedbackDiv.style.display = 'block';
                feedbackDiv.style.borderColor = '#e17055';
                return;
            }
            
            // Analyze response based on key phrases and length
            const assertivePhrases = ['i need', 'my boundary', 'i feel', 'i would prefer', 'i am not comfortable', 'i cannot'];
            const passivePhrases = ['maybe', 'sorry but', 'just', 'kind of', 'if that\'s okay', 'i guess'];
            const aggressivePhrases = ['you always', 'you never', 'you must', 'ridiculous', 'stupid', 'inconsiderate'];
            
            // Count occurrences of phrases
            const assertiveCount = assertivePhrases.filter(phrase => responseText.toLowerCase().includes(phrase)).length;
            const passiveCount = passivePhrases.filter(phrase => responseText.toLowerCase().includes(phrase)).length;
            const aggressiveCount = aggressivePhrases.filter(phrase => responseText.toLowerCase().includes(phrase)).length;
            
            // Determine response type
            let responseType = 'balanced';
            if (assertiveCount > passiveCount && assertiveCount > aggressiveCount) {
                responseType = 'assertive';
            } else if (passiveCount > assertiveCount && passiveCount > aggressiveCount) {
                responseType = 'passive';
            } else if (aggressiveCount > 0) {
                responseType = 'aggressive';
            }
            
            // Generate feedback based on response type
            let feedbackText = '';
            let strengths = '';
            let improvements = '';
            let borderColor = '';
            
            switch (responseType) {
                case 'assertive':
                    feedbackText = 'Your response demonstrates good assertiveness and clear boundary setting.';
                    strengths = 'You used "I" statements effectively and clearly stated your needs.';
                    improvements = 'Consider adding a collaborative element to maintain the relationship while setting the boundary.';
                    borderColor = '#00b894'; // Green
                    break;
                case 'passive':
                    feedbackText = 'Your response appears somewhat passive and may not effectively establish your boundary.';
                    strengths = 'You show consideration for the other person\'s feelings, which is important.';
                    improvements = 'Try removing apologetic language and state your needs more directly. Remember that setting boundaries is your right.';
                    borderColor = '#fdcb6e'; // Yellow
                    break;
                case 'aggressive':
                    feedbackText = 'Your response contains elements that might be perceived as aggressive or accusatory.';
                    strengths = 'You clearly communicate that a boundary has been crossed, which is important.';
                    improvements = 'Try using more "I" statements instead of "you" accusations, and focus on the specific behavior rather than the person.';
                    borderColor = '#e17055'; // Red
                    break;
                default:
                    feedbackText = 'Your response contains a good balance of assertiveness and respect.';
                    strengths = 'You communicate your boundaries while maintaining a respectful tone.';
                    improvements = 'For even more effectiveness, be specific about what you need going forward.';
                    borderColor = '#74b9ff'; // Blue
            }
            
            // Display feedback
            feedbackDiv.innerHTML = `
                <h4 style="color: #ffffff; margin-bottom: 10px;">Boundary Response Analysis:</h4>
                <p style="color: #ffffff; margin-bottom: 15px;">${feedbackText}</p>
                <p style="color: #00b894; margin-bottom: 10px;"><strong>Strengths:</strong> ${strengths}</p>
                <p style="color: #fdcb6e;"><strong>For improvement:</strong> ${improvements}</p>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
                    <p style="color: #ffffff;">Track your practice sessions in your Boundary Tracker to see your progress over time.</p>
                </div>
            `;
            
            feedbackDiv.style.display = 'block';
            feedbackDiv.style.borderColor = borderColor;
            
            // Save practice session to localStorage
            const practiceHistory = JSON.parse(localStorage.getItem('boundaryPractice') || '[]');
            
            practiceHistory.push({
                date: new Date().toLocaleDateString(),
                type: responseType,
                scenario: scenarioType,
                timestamp: new Date().toISOString()
            });
            
            localStorage.setItem('boundaryPractice', JSON.stringify(practiceHistory));
            
            // Show toast notification
            showToast('‚úÖ Practice Saved', 'Your practice session has been analyzed and saved to your progress history.', 'success');
            
            // Change button text temporarily
            this.innerHTML = '‚úÖ Analysis Complete';
            setTimeout(() => {
                this.innerHTML = 'Get Feedback';
            }, 3000);
        });
    }, 100); // Short delay to ensure DOM is ready
}

function openScriptGen() {
    showModal('Script Generator', `
        <div style="padding: 20px;">
            <h3 style="color: #74b9ff; margin-bottom: 20px;">Generate Personal Boundary Scripts</h3>
            
            <div style="margin-bottom: 20px;">
                <label style="color: #ffffff; display: block; margin-bottom: 10px;">What type of boundary do you need to set?</label>
                <select id="boundaryType" style="width: 100%; padding: 10px; border-radius: 5px; border: none;">
                    <option value="time">Time boundary</option>
                    <option value="emotional">Emotional boundary</option>
                    <option value="physical">Physical boundary</option>
                    <option value="digital">Digital boundary</option>
                    <option value="financial">Financial boundary</option>
                </select>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="color: #ffffff; display: block; margin-bottom: 10px;">Describe your situation:</label>
                <textarea id="situationDesc" style="width: 100%; height: 80px; padding: 10px; border-radius: 5px; border: none;" placeholder="Describe the specific situation where you need to set a boundary..."></textarea>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="color: #ffffff; display: block; margin-bottom: 10px;">Your communication style:</label>
                <select id="commStyle" style="width: 100%; padding: 10px; border-radius: 5px; border: none;">
                    <option value="direct">Direct and assertive</option>
                    <option value="gentle">Gentle but firm</option>
                    <option value="formal">Professional/formal</option>
                    <option value="casual">Casual and friendly</option>
                </select>
            </div>
            
            <button onclick="generateScript()" class="btn">Generate My Script</button>
            
            <div id="generatedScript" style="margin-top: 20px; display: none;">
                <h4 style="color: #00b894;">Your Personalized Script:</h4>
                <div id="scriptContent" style="background: #2d3436; padding: 15px; border-radius: 10px; color: #ffffff; font-style: italic;"></div>
            </div>
        </div>
    `);
}

function showModal(title, content) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;';
    
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 20px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #333;">
                <h2 style="color: #ffffff; margin: 0;">${title}</h2>
                <button onclick="this.closest('div').parentElement.remove()" style="background: none; border: none; color: #ffffff; font-size: 1.5rem; cursor: pointer;">‚úï</button>
            </div>
            ${content}
        </div>
    `;
    
    document.body.appendChild(modal);
}

function openConfidenceBuilder() {
    showModal('Confidence Builder', `
        <div style="padding: 20px;">
            <h3 style="color: #74b9ff; margin-bottom: 20px;">Build Boundary Confidence</h3>
            
            <div style="margin-bottom: 20px;">
                <h4 style="color: #00b894; margin-bottom: 15px;">Guided Visualization Exercise</h4>
                <p style="color: #ffffff; margin-bottom: 15px;">Close your eyes and imagine yourself confidently setting a boundary. Click play to begin the 5-minute guided session.</p>
                <button onclick="startVisualization()" class="btn">üéß Start Visualization</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h4 style="color: #74b9ff; margin-bottom: 15px;">Daily Affirmations</h4>
                <div style="background: #2d3436; padding: 15px; border-radius: 10px;">
                    <p style="color: #ffffff; margin-bottom: 10px; font-style: italic;">"I have the right to set boundaries that protect my well-being."</p>
                    <p style="color: #ffffff; margin-bottom: 10px; font-style: italic;">"My boundaries are not selfish - they are necessary."</p>
                    <p style="color: #ffffff; margin-bottom: 10px; font-style: italic;">"I can say no with kindness and confidence."</p>
                    <p style="color: #ffffff; margin: 0; font-style: italic;">"Other people's reactions to my boundaries are not my responsibility."</p>
                </div>
            </div>
            
            <div>
                <h4 style="color: #fd79a8; margin-bottom: 15px;">Confidence Meter</h4>
                <p style="color: #ffffff; margin-bottom: 10px;">Rate your current confidence in setting boundaries:</p>
                <input type="range" id="confidenceMeter" min="1" max="10" value="5" style="width: 100%;">
                <div style="color: #74b9ff; text-align: center;" id="confidenceMeterDisplay">5/10</div>
                <button onclick="trackConfidence()" class="btn" style="margin-top: 10px;">Track Progress</button>
            </div>
        </div>
    `);
    
    setTimeout(() => {
        document.getElementById('confidenceMeter').addEventListener('input', function() {
            document.getElementById('confidenceMeterDisplay').textContent = this.value + '/10';
        });
    }, 100);
}

function openChallenges() {
    showModal('Challenge Vault', `
        <div style="padding: 20px;">
            <h3 style="color: #74b9ff; margin-bottom: 20px;">Daily Boundary Challenges</h3>
            
            <div style="display: grid; gap: 15px;">
                <div style="background: #2d3436; padding: 20px; border-radius: 10px; border-left: 4px solid #00b894;">
                    <h4 style="color: #00b894; margin-bottom: 10px;">üü¢ Beginner Challenge</h4>
                    <p style="color: #ffffff; margin-bottom: 15px;">Practice saying "Let me think about it" instead of immediately saying yes to any request today.</p>
                    <button onclick="acceptChallenge('beginner')" class="btn">Accept Challenge</button>
                </div>
                
                <div style="background: #2d3436; padding: 20px; border-radius: 10px; border-left: 4px solid #74b9ff;">
                    <h4 style="color: #74b9ff; margin-bottom: 10px;">üîµ Intermediate Challenge</h4>
                    <p style="color: #ffffff; margin-bottom: 15px;">Set one time boundary today (e.g., "I'm not available after 8 PM" or "I need 30 minutes to myself").</p>
                    <button onclick="acceptChallenge('intermediate')" class="btn">Accept Challenge</button>
                </div>
                
                <div style="background: #2d3436; padding: 20px; border-radius: 10px; border-left: 4px solid #fd79a8;">
                    <h4 style="color: #fd79a8; margin-bottom: 10px;">üî¥ Advanced Challenge</h4>
                    <p style="color: #ffffff; margin-bottom: 15px;">Have a boundary conversation with someone who has previously pushed back on your limits.</p>
                    <button onclick="acceptChallenge('advanced')" class="btn">Accept Challenge</button>
                </div>
            </div>
            
            <div style="margin-top: 20px; background: linear-gradient(135deg, #636e72 0%, #2d3436 100%); padding: 15px; border-radius: 10px;">
                <h4 style="color: #74b9ff; margin-bottom: 10px;">Today's Bonus Challenge</h4>
                <p style="color: #ffffff; margin: 0;">Practice the "broken record" technique: repeat your boundary 3 times if someone tries to argue with it.</p>
            </div>
        </div>
    `);
}

function openAnalytics() {
    showModal('Progress Analytics', `
        <div style="padding: 20px;">
            <h3 style="color: #74b9ff; margin-bottom: 20px;">Your Boundary Journey Analytics</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div style="background: #2d3436; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2rem; color: #00b894; font-weight: bold;">7</div>
                    <p style="color: #ffffff; margin: 5px 0 0;">Days Active</p>
                </div>
                <div style="background: #2d3436; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2rem; color: #74b9ff; font-weight: bold;">12</div>
                    <p style="color: #ffffff; margin: 5px 0 0;">Boundaries Set</p>
                </div>
                <div style="background: #2d3436; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2rem; color: #fd79a8; font-weight: bold;">85%</div>
                    <p style="color: #ffffff; margin: 5px 0 0;">Success Rate</p>
                </div>
                <div style="background: #2d3436; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2rem; color: #fdcb6e; font-weight: bold;">8.2</div>
                    <p style="color: #ffffff; margin: 5px 0 0;">Confidence Level</p>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h4 style="color: #74b9ff; margin-bottom: 15px;">Weekly Progress Chart</h4>
                <div style="background: #2d3436; padding: 20px; border-radius: 10px;">
                    <div style="height: 100px; background: linear-gradient(to top, #00b894 0%, #74b9ff 50%, #fd79a8 100%); border-radius: 5px; position: relative;">
                        <div style="position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background: linear-gradient(to right, transparent 0%, rgba(116, 185, 255, 0.3) 100%); border-radius: 5px;"></div>
                        <div style="position: absolute; top: 10px; right: 10px; color: #ffffff; font-size: 0.8rem;">Progress Trend ‚Üó</div>
                    </div>
                    <p style="color: #ffffff; margin: 10px 0 0; font-size: 0.9rem; text-align: center;">Your boundary confidence has increased 40% this week!</p>
                </div>
            </div>
            
            <div>
                <h4 style="color: #74b9ff; margin-bottom: 15px;">Insights & Recommendations</h4>
                <div style="background: #2d3436; padding: 15px; border-radius: 10px;">
                    <ul style="color: #ffffff; line-height: 1.6; margin: 0;">
                        <li>You're strongest with time boundaries (90% success rate)</li>
                        <li>Emotional boundaries need more practice (65% success rate)</li>
                        <li>You're most confident setting boundaries with friends</li>
                        <li>Consider working on workplace boundary scenarios next</li>
                    </ul>
                </div>
            </div>
        </div>
    `);
}

// Helper functions for interactive features
function saveBoundaryData() {
    const count = document.getElementById('boundaryCount').value;
    const confidence = document.getElementById('confidenceLevel').value;
    const challenge = document.getElementById('boundaryChallenge').value;
    
    if (!count || count < 0) {
        alert('Please enter a valid number of boundaries set.');
        return;
    }
    
    // Save to localStorage
    const today = new Date().toLocaleDateString();
    const progressData = JSON.parse(localStorage.getItem('boundaryProgress') || '[]');
    
    // Check if entry for today already exists
    const existingIndex = progressData.findIndex(entry => entry.date === today);
    const newEntry = {
        date: today,
        count: parseInt(count),
        confidence: parseInt(confidence),
        challenge: challenge,
        timestamp: new Date().toISOString()
    };
    
    if (existingIndex >= 0) {
        progressData[existingIndex] = newEntry;
    } else {
        progressData.push(newEntry);
    }
    
    localStorage.setItem('boundaryProgress', JSON.stringify(progressData));
    
    // Show success message with toast
    showToast('üéâ Progress Saved Successfully!', 'Your boundary tracking data has been saved and added to your history.', 'success');
    
    // Refresh the progress history display
    loadProgressHistory();
    
    // Clear the form
    document.getElementById('boundaryCount').value = '';
    document.getElementById('confidenceLevel').value = '5';
    document.getElementById('confidenceDisplay').textContent = '5';
    document.getElementById('boundaryChallenge').value = '';
}

function loadProgressHistory() {
    const progressData = JSON.parse(localStorage.getItem('boundaryProgress') || '[]');
    const historyContainer = document.getElementById('progressHistory');
    
    if (progressData.length === 0) {
        historyContainer.innerHTML = `
            <div style="text-align: center; color: #888; padding: 20px;">
                <div style="font-size: 2rem; margin-bottom: 10px;">üìù</div>
                <p>No progress entries yet. Start tracking your boundaries today!</p>
            </div>
        `;
    } else {
        // Sort by date (newest first)
        progressData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        historyContainer.innerHTML = progressData.slice(0, 5).map(entry => `
            <div style="background: #2d3436; border-radius: 10px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #74b9ff;">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                    <span style="color: #74b9ff; font-weight: bold;">${entry.date}</span>
                    <div style="display: flex; gap: 15px;">
                        <span style="color: #00b894;">üéØ ${entry.count} boundaries</span>
                        <span style="color: #fdcb6e;">üí™ ${entry.confidence}/10 confidence</span>
                    </div>
                </div>
                ${entry.challenge ? `<p style="color: #ffffff; margin: 0; font-size: 0.9rem; font-style: italic;">"${entry.challenge.substring(0, 100)}${entry.challenge.length > 100 ? '...' : ''}"</p>` : ''}
            </div>
        `).join('');
        
        if (progressData.length > 5) {
            historyContainer.innerHTML += `
                <div style="text-align: center; color: #74b9ff; font-size: 0.9rem; margin-top: 10px;">
                    Showing latest 5 entries (${progressData.length} total)
                </div>
            `;
        }
    }
    
    // Update summary statistics
    updateProgressStats(progressData);
}

function updateProgressStats(progressData) {
    const totalBoundaries = progressData.reduce((sum, entry) => sum + entry.count, 0);
    const avgConfidence = progressData.length > 0 ? 
        (progressData.reduce((sum, entry) => sum + entry.confidence, 0) / progressData.length).toFixed(1) : 0;
    
    // Calculate streak (consecutive days with entries)
    let streak = 0;
    const today = new Date();
    for (let i = 0; i < 30; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(today.getDate() - i);
        const dateStr = checkDate.toLocaleDateString();
        
        if (progressData.some(entry => entry.date === dateStr)) {
            streak++;
        } else {
            break;
        }
    }
    
    document.getElementById('totalBoundaries').textContent = totalBoundaries;
    document.getElementById('avgConfidence').textContent = avgConfidence;
    document.getElementById('streakDays').textContent = streak;
}

function showToast(title, message, type = 'info') {
    try {
        // Remove existing toast if any
        const existingToast = document.getElementById('progressToast');
        if (existingToast) {
            existingToast.remove();
        }
        
        const colors = {
            success: '#00b894',
            info: '#74b9ff',
            warning: '#fdcb6e',
            error: '#e17055'
        };
        
        const toast = document.createElement('div');
        toast.id = 'progressToast';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, ${colors[type]} 0%, ${colors[type]}aa 100%);
            color: white;
            padding: 20px;
        border-radius: 15px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 350px;
        animation: slideInRight 0.3s ease;
    `;
    
    toast.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">${title}</div>
        <div style="font-size: 0.9rem; opacity: 0.9;">${message}</div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }
    }, 4000);
    } catch (error) {
        console.error('Error showing toast:', error);
    }
}

function evaluateResponse() {
    try {
        const currentModal = document.querySelector('div[style*="position: fixed"][style*="z-index: 1000"]');
        if (!currentModal) return;
        
        const response = currentModal.querySelector('#practiceResponse').value.trim();
        const feedback = currentModal.querySelector('#responseFeedback');
        
        if (!response) {
            feedback.innerHTML = `
                <p style="color: #e17055; margin-bottom: 10px;">Please enter your response first.</p>
            `;
            feedback.style.display = 'block';
            feedback.style.borderColor = '#e17055';
            return;
        }
        
        // Analyze response based on key phrases and length
        const assertivePhrases = ['i need', 'my boundary', 'i feel', 'i would prefer', 'i am not comfortable', 'i cannot'];
        const passivePhrases = ['maybe', 'sorry but', 'just', 'kind of', 'if that\'s okay', 'i guess'];
        const aggressivePhrases = ['you always', 'you never', 'you must', 'ridiculous', 'stupid', 'inconsiderate'];
    
    // Count occurrences of phrases
    const assertiveCount = assertivePhrases.filter(phrase => response.toLowerCase().includes(phrase)).length;
    const passiveCount = passivePhrases.filter(phrase => response.toLowerCase().includes(phrase)).length;
    const aggressiveCount = aggressivePhrases.filter(phrase => response.toLowerCase().includes(phrase)).length;
    
    // Determine response type
    let responseType = 'balanced';
    if (assertiveCount > passiveCount && assertiveCount > aggressiveCount) {
        responseType = 'assertive';
    } else if (passiveCount > assertiveCount && passiveCount > aggressiveCount) {
        responseType = 'passive';
    } else if (aggressiveCount > 0) {
        responseType = 'aggressive';
    }
    
    // Generate feedback based on response type
    let feedbackText = '';
    let strengths = '';
    let improvements = '';
    let borderColor = '';
    
    switch (responseType) {
        case 'assertive':
            feedbackText = 'Your response demonstrates good assertiveness and clear boundary setting.';
            strengths = 'You used "I" statements effectively and clearly stated your needs.';
            improvements = 'Consider adding a collaborative element to maintain the relationship while setting the boundary.';
            borderColor = '#00b894'; // Green
            break;
        case 'passive':
            feedbackText = 'Your response appears somewhat passive and may not effectively establish your boundary.';
            strengths = 'You show consideration for the other person\'s feelings, which is important.';
            improvements = 'Try removing apologetic language and state your needs more directly. Remember that setting boundaries is your right.';
            borderColor = '#fdcb6e'; // Yellow
            break;
        case 'aggressive':
            feedbackText = 'Your response contains elements that might be perceived as aggressive or accusatory.';
            strengths = 'You clearly communicate that a boundary has been crossed, which is important.';
            improvements = 'Try using more "I" statements instead of "you" accusations, and focus on the specific behavior rather than the person.';
            borderColor = '#e17055'; // Red
            break;
        default:
            feedbackText = 'Your response contains a good balance of assertiveness and respect.';
            strengths = 'You communicate your boundaries while maintaining a respectful tone.';
            improvements = 'For even more effectiveness, be specific about what you need going forward.';
            borderColor = '#74b9ff'; // Blue
    }
    
    feedback.innerHTML = `
        <h4 style="color: #ffffff; margin-bottom: 10px;">Boundary Response Analysis:</h4>
        <p style="color: #ffffff; margin-bottom: 15px;">${feedbackText}</p>
        <p style="color: #00b894; margin-bottom: 10px;"><strong>Strengths:</strong> ${strengths}</p>
        <p style="color: #fdcb6e;"><strong>For improvement:</strong> ${improvements}</p>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
            <p style="color: #ffffff;">Track your practice sessions in your Boundary Tracker to see your progress over time.</p>
        </div>
    `;
    
    feedback.style.display = 'block';
    feedback.style.borderColor = borderColor;
    
    // Add visual feedback that the analysis is complete
    const feedbackButton = currentModal.querySelector('button[onclick="evaluateResponse()"]');
    if (feedbackButton) {
        feedbackButton.innerHTML = '‚úÖ Analysis Complete';
        setTimeout(() => {
            feedbackButton.innerHTML = 'Get Feedback';
        }, 3000);
    }
    
    // Add to practice history in localStorage
    savePracticeSession(responseType);
    } catch (error) {
        console.error('Error evaluating response:', error);
        showToast('‚ö†Ô∏è Error', 'There was an error analyzing your response.', 'error');
    }
}

// This function has been refactored and integrated directly into the evaluateResponse logic in startScenario
// and in endPracticeSession to avoid any function call issues

function endPracticeSession(scenarioType) {
    try {
        // Get the modal and response
        const modal = document.getElementById('scenarioPracticeModal');
        if (!modal) {
            console.error('Practice modal not found when ending session');
            return;
        }
        
        // Check if there's an unsaved response
        const response = document.getElementById('scenarioPracticeResponse');
        const feedback = document.getElementById('scenarioPracticeFeedback');
        
        if (response && response.value.trim() && (!feedback || feedback.style.display === 'none')) {
            // If there's a response but user didn't click Get Feedback, save it anyway
            const text = response.value.trim().toLowerCase();
            const assertivePhrases = ['i need', 'my boundary', 'i feel', 'i would prefer', 'i am not comfortable'];
            const isAssertive = assertivePhrases.some(phrase => text.includes(phrase));
            
            try {
                // Save to localStorage
                const practiceHistory = JSON.parse(localStorage.getItem('boundaryPractice') || '[]');
                practiceHistory.push({
                    date: new Date().toLocaleDateString(),
                    type: isAssertive ? 'assertive' : 'balanced',
                    scenario: scenarioType || 'general',
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('boundaryPractice', JSON.stringify(practiceHistory));
                
                // Refresh progress display if it's visible
                if (typeof loadProgressHistory === 'function') {
                    loadProgressHistory();
                }
            } catch (storageError) {
                console.error('Error saving practice to localStorage:', storageError);
            }
        }
        
        // Close the modal
        modal.remove();
        
        // Show completion message
        showToast('‚úÖ Practice Session Complete', 'Your practice session has been saved to your progress.', 'success');
    } catch (error) {
        console.error('Error in endPracticeSession:', error);
        showToast('‚ö†Ô∏è Error', 'There was an error ending the practice session.', 'error');
    }
}

function generateScript() {
    const boundaryType = document.getElementById('boundaryType').value;
    const situation = document.getElementById('situationDesc').value;
    const style = document.getElementById('commStyle').value;
    
    const scripts = {
        time: {
            direct: "I won't be able to take that on right now. My schedule is full until [date].",
            gentle: "I appreciate you thinking of me, but I'm not available for that right now.",
            formal: "Thank you for the opportunity. However, I must decline due to scheduling constraints.",
            casual: "Hey, I'd love to help but I'm swamped right now. Maybe another time?"
        },
        emotional: {
            direct: "I'm not comfortable discussing this topic. Let's talk about something else.",
            gentle: "I understand you need to vent, but I'm not in the right headspace to hear this right now.",
            formal: "I prefer to keep our conversations focused on [topic]. I hope you understand.",
            casual: "I hear you, but I need to step back from heavy conversations today."
        },
        physical: {
            direct: "I need my personal space respected. Please don't [specific behavior].",
            gentle: "I'm more comfortable with a bit more space between us.",
            formal: "I prefer to maintain professional physical boundaries in our interactions.",
            casual: "Hey, I'm not much of a hugger. Hope that's okay!"
        }
    };
    
    const script = scripts[boundaryType]?.[style] || "I need to set a boundary here. Can we discuss how to move forward respectfully?";
    
    document.getElementById('generatedScript').style.display = 'block';
    document.getElementById('scriptContent').textContent = script;
}

function acceptChallenge(level) {
    alert(`Challenge Accepted! You've taken on a ${level} boundary challenge. Good luck! üéØ`);
    // In real app, this would track the challenge acceptance
}

function startVisualization() {
    // Create visualization modal
    let visualizationModal = document.createElement('div');
    visualizationModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; align-items: center; justify-content: center;';
    
    const steps = [
        {
            title: "Prepare",
            instruction: "Find a comfortable position. Take a few moments to settle in.",
            duration: 20,
            breathingPattern: "normal"
        },
        {
            title: "Focus",
            instruction: "Close your eyes. Begin to focus on your breathing.",
            duration: 30,
            breathingPattern: "inhale-hold-exhale"
        },
        {
            title: "Visualize",
            instruction: "Imagine a situation where you need to set a boundary. See yourself speaking clearly and confidently.",
            duration: 60,
            breathingPattern: "deep"
        },
        {
            title: "Feel",
            instruction: "Notice how it feels to honor your needs. Feel the confidence flowing through you.",
            duration: 60,
            breathingPattern: "deep"
        },
        {
            title: "Affirm",
            instruction: "Say to yourself: 'I have the right to set boundaries. My needs matter.'",
            duration: 30,
            breathingPattern: "normal"
        },
        {
            title: "Complete",
            instruction: "Bring your awareness back to the present. Open your eyes when ready.",
            duration: 20,
            breathingPattern: "normal"
        }
    ];
    
    let currentStep = 0;
    let timer = null;
    let timeLeft = steps[0].duration;
    
    // Create modal content
    visualizationModal.innerHTML = `
        <div style="background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%); border-radius: 20px; max-width: 700px; width: 90%; color: white; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
            <div style="padding: 25px 30px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; font-size: 1.8rem; color: #74b9ff;">Guided Visualization</h2>
                <button id="closeVisualization" style="background: none; border: none; color: #ffffff; font-size: 1.8rem; cursor: pointer; opacity: 0.8; transition: opacity 0.3s;">‚úï</button>
            </div>
            
            <div style="padding: 30px;">
                <div style="margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 id="step-title" style="margin: 0; font-size: 1.5rem; color: #00b894;">${steps[0].title}</h3>
                        <div id="timer" style="font-size: 1.3rem; color: #74b9ff; font-weight: bold;">${steps[0].duration}s</div>
                    </div>
                    <div style="height: 8px; width: 100%; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin: 15px 0;">
                        <div id="progress-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #74b9ff, #00b894); transition: width 1s ease;"></div>
                    </div>
                </div>
                
                <div style="margin: 30px 0;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <p id="instruction" style="font-size: 1.2rem; line-height: 1.6; color: #ffffff;">${steps[0].instruction}</p>
                    </div>
                    
                    <div id="breathing-animation" style="text-align: center; margin: 40px 0;">
                        <div style="width: 100px; height: 100px; background: radial-gradient(circle, #74b9ff 0%, #0984e3 100%); border-radius: 50%; margin: 0 auto; opacity: 0.8; transform: scale(1); transition: transform 4s ease, opacity 4s ease;"></div>
                        <p id="breathing-text" style="margin-top: 20px; font-size: 1.1rem; color: #74b9ff;">Breathe naturally</p>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                    <button id="prev-step" class="btn" style="opacity: 0.5; cursor: not-allowed;">Previous</button>
                    <div id="step-indicator" style="color: #74b9ff;">Step 1/${steps.length}</div>
                    <button id="next-step" class="btn">Next</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(visualizationModal);
    
    // Elements
    const closeButton = document.getElementById('closeVisualization');
    const stepTitle = document.getElementById('step-title');
    const timerElement = document.getElementById('timer');
    const progressBar = document.getElementById('progress-bar');
    const instruction = document.getElementById('instruction');
    const breathingAnimation = document.getElementById('breathing-animation').querySelector('div');
    const breathingText = document.getElementById('breathing-text');
    const prevButton = document.getElementById('prev-step');
    const nextButton = document.getElementById('next-step');
    const stepIndicator = document.getElementById('step-indicator');
    
    // Handle closing
    closeButton.addEventListener('click', () => {
        clearInterval(timer);
        visualizationModal.remove();
    });
    
    // Update the UI for a given step
    function updateUI(stepIndex) {
        const step = steps[stepIndex];
        
        stepTitle.textContent = step.title;
        instruction.textContent = step.instruction;
        timerElement.textContent = step.duration + 's';
        stepIndicator.textContent = `Step ${stepIndex + 1}/${steps.length}`;
        progressBar.style.width = '0%';
        
        // Update breathing animation based on pattern
        if (step.breathingPattern === 'deep') {
            animateDeepBreathing();
            breathingText.textContent = 'Breathe deeply';
        } else if (step.breathingPattern === 'inhale-hold-exhale') {
            animateInhaleHoldExhale();
            breathingText.textContent = 'Inhale... Hold... Exhale...';
        } else {
            animateNormalBreathing();
            breathingText.textContent = 'Breathe naturally';
        }
        
        // Handle button states
        prevButton.style.opacity = stepIndex === 0 ? '0.5' : '1';
        prevButton.style.cursor = stepIndex === 0 ? 'not-allowed' : 'pointer';
        nextButton.textContent = stepIndex === steps.length - 1 ? 'Complete' : 'Next';
        
        // Reset timer
        timeLeft = step.duration;
        timerElement.textContent = timeLeft + 's';
    }
    
    // Different breathing animations
    function animateNormalBreathing() {
        breathingAnimation.style.animation = 'none';
        setTimeout(() => {
            breathingAnimation.style.animation = 'breathe 5s infinite ease-in-out';
        }, 10);
    }
    
    function animateDeepBreathing() {
        breathingAnimation.style.animation = 'none';
        setTimeout(() => {
            breathingAnimation.style.animation = 'deepBreathe 8s infinite ease-in-out';
        }, 10);
    }
    
    function animateInhaleHoldExhale() {
        breathingAnimation.style.animation = 'none';
        setTimeout(() => {
            breathingAnimation.style.animation = 'inhaleHoldExhale 10s infinite ease-in-out';
        }, 10);
    }
    
    // Start timer for current step
    function startTimer() {
        clearInterval(timer);
        const totalDuration = steps[currentStep].duration;
        
        timer = setInterval(() => {
            timeLeft--;
            timerElement.textContent = timeLeft + 's';
            
            // Update progress bar
            const progress = (totalDuration - timeLeft) / totalDuration * 100;
            progressBar.style.width = progress + '%';
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                if (currentStep < steps.length - 1) {
                    currentStep++;
                    updateUI(currentStep);
                    startTimer();
                }
            }
        }, 1000);
    }
    
    // Event listeners for buttons
    prevButton.addEventListener('click', () => {
        if (currentStep > 0) {
            currentStep--;
            updateUI(currentStep);
            startTimer();
        }
    });
    
    nextButton.addEventListener('click', () => {
        if (currentStep < steps.length - 1) {
            currentStep++;
            updateUI(currentStep);
            startTimer();
        } else {
            // Complete the visualization
            clearInterval(timer);
            visualizationModal.remove();
            
            // Show completion message
            setTimeout(() => {
                showModal('Visualization Complete', `
                    <div style="padding: 20px; text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">‚ú®</div>
                        <h3 style="color: #00b894; margin-bottom: 15px;">Well Done!</h3>
                        <p style="color: #ffffff; margin-bottom: 20px;">You've completed your guided visualization. How do you feel?</p>
                        <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
                            <button onclick="saveVisualizationFeeling('confident')" class="btn" style="background: #00b894;">More Confident</button>
                            <button onclick="saveVisualizationFeeling('calm')" class="btn" style="background: #74b9ff;">Calmer</button>
                            <button onclick="saveVisualizationFeeling('reflective')" class="btn" style="background: #a29bfe;">Reflective</button>
                        </div>
                        <p style="color: #74b9ff; margin-top: 15px;">Practice this visualization daily for best results.</p>
                    </div>
                `);
            }, 300);
        }
    });
    
    // Add animation styles
    const styleElement = document.createElement('style');
    styleElement.textContent = `
        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        
        @keyframes deepBreathe {
            0%, 100% { transform: scale(0.8); opacity: 0.7; }
            50% { transform: scale(1.5); opacity: 1; }
        }
        
        @keyframes inhaleHoldExhale {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            30% { transform: scale(1.5); opacity: 1; }
            50% { transform: scale(1.5); opacity: 1; }
            80% { transform: scale(1); opacity: 0.7; }
        }
    `;
    document.head.appendChild(styleElement);
    
    // Start the first step
    updateUI(0);
    startTimer();
}

function trackConfidence() {
    const confidence = document.getElementById('confidenceMeter').value;
    
    // Save confidence tracking to localStorage
    const currentDate = new Date().toLocaleDateString();
    const confidenceData = JSON.parse(localStorage.getItem('confidenceTracking') || '[]');
    
    // Create new confidence entry
    const newEntry = {
        date: currentDate,
        confidence: parseInt(confidence),
        timestamp: new Date().toISOString()
    };
    
    // Add to history
    confidenceData.push(newEntry);
    localStorage.setItem('confidenceTracking', JSON.stringify(confidenceData));
    
    // Show success toast notification instead of alert
    showToast('üí™ Confidence Tracked!', `Confidence level ${confidence}/10 recorded! Keep building your boundary muscles!`, 'success');
    
    // Update any existing progress displays if they're visible
    if (typeof loadProgressHistory === 'function') {
        loadProgressHistory();
    }
    if (typeof loadVisualizationHistory === 'function') {
        loadVisualizationHistory();
    }
}

function saveVisualizationFeeling(feeling) {
    // Save visualization completion data to localStorage
    const currentDate = new Date().toLocaleDateString();
    const visualizationData = JSON.parse(localStorage.getItem('visualizationHistory') || '[]');
    
    // Create new entry
    const newEntry = {
        date: currentDate,
        feeling: feeling,
        timestamp: new Date().toISOString()
    };
    
    // Add to history
    visualizationData.push(newEntry);
    localStorage.setItem('visualizationHistory', JSON.stringify(visualizationData));
    
    // Get the button clicked to provide visual feedback
    const modalElement = document.querySelector('div[style*="position: fixed"][style*="z-index: 1000"]');
    const clickedButton = modalElement.querySelector(`button[onclick*="${feeling}"]`);
    const originalText = clickedButton ? clickedButton.textContent : '';
    
    // Update button to show saved confirmation
    clickedButton.textContent = '‚úì Saved';
    clickedButton.style.background = '#00b894';
    
    // Disable all buttons to prevent multiple selections
    const allButtons = clickedButton.parentElement.querySelectorAll('button');
    allButtons.forEach(btn => {
        if (btn !== clickedButton) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
        }
    });
    
    // Show success message
    showToast('‚úÖ Feeling Recorded', 'Your response after visualization has been saved to track your progress.', 'success');
    
    // Add this visualization session to boundary progress
    const progressData = JSON.parse(localStorage.getItem('boundaryProgress') || '[]');
    
    // Check if entry for today already exists
    const existingIndex = progressData.findIndex(entry => entry.date === currentDate);
    
    if (existingIndex >= 0) {
        // Update existing entry to include visualization
        progressData[existingIndex].visualizationsCompleted = 
            (progressData[existingIndex].visualizationsCompleted || 0) + 1;
    } else {
        // Create new entry for today
        progressData.push({
            date: currentDate,
            visualizationsCompleted: 1,
            timestamp: new Date().toISOString()
        });
    }
    
    localStorage.setItem('boundaryProgress', JSON.stringify(progressData));
    
    // Refresh visualization history display if it exists (in boundary tracker)
    if (typeof loadVisualizationHistory === 'function') {
        loadVisualizationHistory();
    }
    
    // Close modal after delay
    setTimeout(() => {
        // Find the modal element (which is the outermost parent of the button)
        const modalElement = document.querySelector('div[style*="position: fixed"][style*="z-index: 1000"]');
        if (modalElement) modalElement.remove();
    }, 2000);
}

function loadVisualizationHistory() {
    const visualizationData = JSON.parse(localStorage.getItem('visualizationHistory') || '[]');
    const historyContainer = document.getElementById('visualizationHistory');
    
    if (!historyContainer) return;
    
    if (visualizationData.length === 0) {
        historyContainer.innerHTML = `
            <div style="text-align: center; color: #888; padding: 20px;">
                <div style="font-size: 2rem; margin-bottom: 10px;">üßò</div>
                <p>No visualization sessions recorded yet. Complete a guided visualization to see your history here.</p>
            </div>
        `;
    } else {
        // Sort by date (newest first)
        visualizationData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        // Display feelings with appropriate icons and colors
        const feelingIcons = {
            'confident': 'üí™',
            'calm': 'üòå',
            'reflective': 'ü§î'
        };
        
        const feelingColors = {
            'confident': '#00b894',
            'calm': '#74b9ff',
            'reflective': '#a29bfe'
        };
        
        const feelingLabels = {
            'confident': 'More Confident',
            'calm': 'Calmer',
            'reflective': 'Reflective'
        };
        
        historyContainer.innerHTML = visualizationData.slice(0, 10).map(entry => `
            <div style="background: #2d3436; border-radius: 10px; padding: 15px; margin-bottom: 10px; border-left: 4px solid ${feelingColors[entry.feeling] || '#74b9ff'};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #ffffff; font-weight: bold;">${entry.date}</span>
                    <span style="color: ${feelingColors[entry.feeling] || '#74b9ff'}; font-weight: bold;">
                        ${feelingIcons[entry.feeling] || '‚ú®'} ${feelingLabels[entry.feeling] || entry.feeling}
                    </span>
                </div>
            </div>
        `).join('');
        
        if (visualizationData.length > 10) {
            historyContainer.innerHTML += `
                <div style="text-align: center; color: #74b9ff; font-size: 0.9rem; margin-top: 10px;">
                    Showing latest 10 entries (${visualizationData.length} total)
                </div>
            `;
        }
        
        // Add statistics summary
        const confident = visualizationData.filter(entry => entry.feeling === 'confident').length;
        const calm = visualizationData.filter(entry => entry.feeling === 'calm').length;
        const reflective = visualizationData.filter(entry => entry.feeling === 'reflective').length;
        
        historyContainer.innerHTML += `
            <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #2d3436 0%, #636e72 100%); border-radius: 10px;">
                <p style="color: #ffffff; margin: 0 0 10px 0; text-align: center;">Visualization Results</p>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                    <div>
                        <div style="color: #00b894; font-size: 1.2rem; font-weight: bold;">${confident}</div>
                        <div style="color: #ffffff; font-size: 0.8rem;">More Confident</div>
                    </div>
                    <div>
                        <div style="color: #74b9ff; font-size: 1.2rem; font-weight: bold;">${calm}</div>
                        <div style="color: #ffffff; font-size: 0.8rem;">Calmer</div>
                    </div>
                    <div>
                        <div style="color: #a29bfe; font-size: 1.2rem; font-weight: bold;">${reflective}</div>
                        <div style="color: #ffffff; font-size: 0.8rem;">Reflective</div>
                    </div>
                </div>
            </div>
        `;
    }
}

// Quick action functions
function emergencyScript() {
    alert('Emergency Script: "I need to think about this. I\'ll get back to you." - Use this when you feel pressured!');
}

function dailyReflection() {
    showModal('Daily Reflection', `
        <div style="padding: 20px;">
            <h3 style="color: #74b9ff; margin-bottom: 20px;">Today's Boundary Reflection</h3>
            <p style="color: #ffffff; margin-bottom: 25px; line-height: 1.6;">
                Take a few moments to reflect on your boundary experiences today. This helps you build awareness and improve your boundary-setting skills.
            </p>
            
            <div style="margin-bottom: 20px;">
                <label style="color: #ffffff; display: block; margin-bottom: 10px; font-weight: bold;">1. What boundary situation did you handle well today?</label>
                <textarea id="reflectionSuccess" style="width: 100%; height: 80px; padding: 12px; border-radius: 8px; border: none; resize: vertical;" placeholder="Describe a moment where you successfully maintained or set a boundary..."></textarea>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="color: #ffffff; display: block; margin-bottom: 10px; font-weight: bold;">2. What boundary challenge did you face today?</label>
                <textarea id="reflectionChallenge" style="width: 100%; height: 80px; padding: 12px; border-radius: 8px; border: none; resize: vertical;" placeholder="Describe a situation where you struggled with boundaries or wish you had handled differently..."></textarea>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="color: #ffffff; display: block; margin-bottom: 10px; font-weight: bold;">3. How are you feeling about your boundary progress?</label>
                <select id="reflectionMood" style="width: 100%; padding: 12px; border-radius: 8px; border: none;">
                    <option value="">Select your feeling...</option>
                    <option value="confident">Confident - I'm getting stronger at this!</option>
                    <option value="frustrated">Frustrated - It's harder than I thought</option>
                    <option value="hopeful">Hopeful - I can see progress even if it's slow</option>
                    <option value="overwhelmed">Overwhelmed - There's so much to work on</option>
                    <option value="proud">Proud - I made real progress today</option>
                    <option value="uncertain">Uncertain - I'm not sure if I'm doing this right</option>
                </select>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="color: #ffffff; display: block; margin-bottom: 10px; font-weight: bold;">4. What's one thing you want to focus on tomorrow?</label>
                <textarea id="reflectionGoal" style="width: 100%; height: 60px; padding: 12px; border-radius: 8px; border: none; resize: vertical;" placeholder="Set one specific boundary intention for tomorrow..."></textarea>
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="color: #ffffff; display: block; margin-bottom: 10px; font-weight: bold;">5. Rate your overall boundary confidence today (1-10):</label>
                <input type="range" id="reflectionConfidence" min="1" max="10" value="5" style="width: 100%; margin-bottom: 10px;">
                <div style="color: #74b9ff; text-align: center; font-size: 1.1rem; font-weight: bold;" id="reflectionConfidenceDisplay">5/10</div>
            </div>
            
            <div style="display: flex; justify-content: space-between; gap: 10px; margin-bottom: 15px;">
                <button onclick="saveReflection()" class="btn" style="flex: 1; background: linear-gradient(135deg, #00b894 0%, #00a085 100%);">
                    üíæ Save Reflection
                </button>
                <button onclick="viewReflectionHistory()" class="btn" style="flex: 1; background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);">
                    üìñ View Past Reflections
                </button>
                <button onclick="document.querySelector('div[style*=\"position: fixed\"][style*=\"z-index: 1000\"]').remove()" class="btn btn-secondary" style="flex: 0 0 auto;">
                    Cancel
                </button>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #2d3436 0%, #636e72 100%); border-radius: 10px;">
                <p style="color: #74b9ff; margin: 0; text-align: center; font-style: italic;">
                    üí° Regular reflection strengthens your boundary awareness and helps you grow faster.
                </p>
            </div>
        </div>
    `);
    
    // Add event listener for confidence slider
    setTimeout(() => {
        const confidenceSlider = document.getElementById('reflectionConfidence');
        const confidenceDisplay = document.getElementById('reflectionConfidenceDisplay');
        
        if (confidenceSlider && confidenceDisplay) {
            confidenceSlider.addEventListener('input', function() {
                confidenceDisplay.textContent = this.value + '/10';
            });
        }
    }, 100);
}

function saveReflection() {
    // Get all reflection data
    const success = document.getElementById('reflectionSuccess').value.trim();
    const challenge = document.getElementById('reflectionChallenge').value.trim();
    const mood = document.getElementById('reflectionMood').value;
    const goal = document.getElementById('reflectionGoal').value.trim();
    const confidence = document.getElementById('reflectionConfidence').value;
    
    // Validate required fields
    if (!success && !challenge && !mood) {
        showToast('‚ö†Ô∏è Incomplete Reflection', 'Please fill out at least one reflection question before saving.', 'warning');
        return;
    }
    
    // Save reflection to localStorage
    const currentDate = new Date().toLocaleDateString();
    const reflectionData = JSON.parse(localStorage.getItem('dailyReflections') || '[]');
    
    // Create new reflection entry
    const newReflection = {
        date: currentDate,
        success: success,
        challenge: challenge,
        mood: mood,
        goal: goal,
        confidence: parseInt(confidence),
        timestamp: new Date().toISOString()
    };
    
    // Check if reflection for today already exists
    const existingIndex = reflectionData.findIndex(entry => entry.date === currentDate);
    
    if (existingIndex >= 0) {
        // Update existing reflection
        reflectionData[existingIndex] = newReflection;
        showToast('‚úÖ Reflection Updated', 'Your daily reflection has been updated successfully!', 'success');
    } else {
        // Add new reflection
        reflectionData.push(newReflection);
        showToast('‚úÖ Reflection Saved', 'Your daily reflection has been saved! Keep up the great work.', 'success');
    }
    
    localStorage.setItem('dailyReflections', JSON.stringify(reflectionData));
    
    // Update any visible progress displays
    if (typeof loadProgressHistory === 'function') {
        loadProgressHistory();
    }
    
    // Close the modal after a short delay
    setTimeout(() => {
        const modal = document.querySelector('div[style*="position: fixed"][style*="z-index: 1000"]');
        if (modal) modal.remove();
    }, 1500);
}

function viewReflectionHistory() {
    // Close current modal first
    const currentModal = document.querySelector('div[style*="position: fixed"][style*="z-index: 1000"]');
    if (currentModal) currentModal.remove();
    
    // Get reflection data
    const reflectionData = JSON.parse(localStorage.getItem('dailyReflections') || '[]');
    
    if (reflectionData.length === 0) {
        showModal('üìñ Your Reflection History', `
            <div style="padding: 20px; text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 20px;">üí≠</div>
                <h3 style="color: #74b9ff; margin-bottom: 15px;">No Reflections Yet</h3>
                <p style="color: #ffffff; margin-bottom: 20px;">You haven't saved any daily reflections yet. Start reflecting on your boundary journey!</p>
                <button onclick="dailyReflection()" class="btn">
                    ‚ú® Start Your First Reflection
                </button>
            </div>
        `);
        return;
    }
    
    // Sort reflections by date (newest first)
    reflectionData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    // Calculate stats
    const avgConfidence = (reflectionData.reduce((sum, entry) => sum + (entry.confidence || 5), 0) / reflectionData.length).toFixed(1);
    const moodCounts = reflectionData.reduce((counts, entry) => {
        if (entry.mood) {
            counts[entry.mood] = (counts[entry.mood] || 0) + 1;
        }
        return counts;
    }, {});
    const topMood = Object.keys(moodCounts).length > 0 ? 
        Object.keys(moodCounts).reduce((a, b) => moodCounts[a] > moodCounts[b] ? a : b) : 'balanced';
    
    showModal('üìñ Your Reflection History', `
        <div style="padding: 20px;">
            <h3 style="color: #74b9ff; margin-bottom: 20px;">Your Daily Reflection Journey</h3>
            
            <!-- Summary Stats -->
            <div style="background: linear-gradient(135deg, #2d3436 0%, #636e72 100%); border-radius: 15px; padding: 20px; margin-bottom: 25px;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                    <div>
                        <div style="color: #74b9ff; font-size: 1.5rem; font-weight: bold;">${reflectionData.length}</div>
                        <div style="color: #ffffff; font-size: 0.9rem;">Total Reflections</div>
                    </div>
                    <div>
                        <div style="color: #00b894; font-size: 1.5rem; font-weight: bold;">${avgConfidence}</div>
                        <div style="color: #ffffff; font-size: 0.9rem;">Avg Confidence</div>
                    </div>
                    <div>
                        <div style="color: #fdcb6e; font-size: 1.5rem; font-weight: bold;">${topMood.charAt(0).toUpperCase() + topMood.slice(1)}</div>
                        <div style="color: #ffffff; font-size: 0.9rem;">Most Common Mood</div>
                    </div>
                </div>
            </div>
            
            <!-- Reflection History -->
            <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                ${reflectionData.map(entry => {
                    const moodColors = {
                        'confident': '#00b894',
                        'frustrated': '#e17055',
                        'hopeful': '#74b9ff',
                        'overwhelmed': '#fdcb6e',
                        'proud': '#00b894',
                        'uncertain': '#a29bfe'
                    };
                    
                    const moodIcons = {
                        'confident': 'üí™',
                        'frustrated': 'üò§',
                        'hopeful': 'üåü',
                        'overwhelmed': 'üò∞',
                        'proud': 'üéâ',
                        'uncertain': 'ü§î'
                    };
                    
                    return `
                        <div style="background: #2d3436; border-radius: 15px; padding: 20px; margin-bottom: 15px; border-left: 4px solid ${moodColors[entry.mood] || '#74b9ff'};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: #ffffff; margin: 0;">${entry.date}</h4>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    ${entry.mood ? `<span style="color: ${moodColors[entry.mood] || '#74b9ff'}; font-weight: bold;">${moodIcons[entry.mood] || 'üí≠'} ${entry.mood.charAt(0).toUpperCase() + entry.mood.slice(1)}</span>` : ''}
                                    <span style="color: #74b9ff; font-weight: bold;">Confidence: ${entry.confidence}/10</span>
                                </div>
                            </div>
                            
                            ${entry.success ? `
                                <div style="margin-bottom: 12px;">
                                    <div style="color: #00b894; font-weight: bold; margin-bottom: 5px;">‚úÖ Success:</div>
                                    <div style="color: #ffffff; line-height: 1.4;">${entry.success}</div>
                                </div>
                            ` : ''}
                            
                            ${entry.challenge ? `
                                <div style="margin-bottom: 12px;">
                                    <div style="color: #fdcb6e; font-weight: bold; margin-bottom: 5px;">‚ö†Ô∏è Challenge:</div>
                                    <div style="color: #ffffff; line-height: 1.4;">${entry.challenge}</div>
                                </div>
                            ` : ''}
                            
                            ${entry.goal ? `
                                <div style="margin-bottom: 12px;">
                                    <div style="color: #a29bfe; font-weight: bold; margin-bottom: 5px;">üéØ Tomorrow's Goal:</div>
                                    <div style="color: #ffffff; line-height: 1.4;">${entry.goal}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
            
            <div style="display: flex; justify-content: space-between; gap: 15px;">
                <button onclick="dailyReflection()" class="btn" style="flex: 1;">
                    ‚ú® New Reflection
                </button>
                <button onclick="viewProgressHistory()" class="btn" style="flex: 1; background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);">
                    üìä View All Progress
                </button>
            </div>
        </div>
    `);
}

function boundaryReminder() {
    alert('Boundary Reminder set! (This would set up daily affirmations and reminders)');
}

function communityForum() {
    alert('Community Forum opening... (This would connect you with other boundary-builders)');
}

function viewProgressHistory() {
    // Get progress data from localStorage
    const progressData = JSON.parse(localStorage.getItem('boundaryProgress') || '[]');
    const practiceData = JSON.parse(localStorage.getItem('boundaryPractice') || '[]');
    const visualizationData = JSON.parse(localStorage.getItem('visualizationHistory') || '[]');
    const reflectionData = JSON.parse(localStorage.getItem('dailyReflections') || '[]');
    
    // Create progress history content
    let historyContent = '';
    
    if (progressData.length === 0 && practiceData.length === 0 && visualizationData.length === 0 && reflectionData.length === 0) {
        historyContent = `
            <div style="text-align: center; color: #888; padding: 20px;">
                <div style="font-size: 3rem; margin-bottom: 10px;">üìù</div>
                <p>No progress entries yet. Start tracking your boundaries today!</p>
                <button onclick="openTracker()" class="btn" style="margin-top: 15px;">Open Boundary Tracker</button>
            </div>
        `;
    } else {
        // Calculate statistics
        const totalBoundaries = progressData.reduce((sum, entry) => sum + entry.count, 0);
        const avgConfidence = progressData.length > 0 ? 
            (progressData.reduce((sum, entry) => sum + entry.confidence, 0) / progressData.length).toFixed(1) : 0;
        
        // Calculate streak
        let streak = 0;
        const today = new Date();
        for (let i = 0; i < 30; i++) {
            const checkDate = new Date(today);
            checkDate.setDate(today.getDate() - i);
            const dateStr = checkDate.toLocaleDateString();
            
            if (progressData.some(entry => entry.date === dateStr)) {
                streak++;
            } else {
                break;
            }
        }
        
        // Practice session stats
        const totalPractices = practiceData.length;
        const assertivePractices = practiceData.filter(p => p.type === 'assertive').length;
        const assertivePercentage = totalPractices > 0 ? Math.round((assertivePractices / totalPractices) * 100) : 0;
        
        // Visualization stats
        const totalVisualizations = visualizationData.length;
        const confidentCount = visualizationData.filter(entry => entry.feeling === 'confident').length;
        const calmCount = visualizationData.filter(entry => entry.feeling === 'calm').length;
        const reflectiveCount = visualizationData.filter(entry => entry.feeling === 'reflective').length;
        
        // Reflection stats
        const totalReflections = reflectionData.length;
        const avgReflectionConfidence = reflectionData.length > 0 ? 
            (reflectionData.reduce((sum, entry) => sum + (entry.confidence || 5), 0) / reflectionData.length).toFixed(1) : 0;
        
        historyContent = `
            <div style="padding: 20px;">
                <div style="background: linear-gradient(135deg, #2d3436 0%, #636e72 100%); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #74b9ff; margin-bottom: 15px; text-align: center;">Your Boundary Progress</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                        <div>
                            <div style="color: #00b894; font-size: 2rem; font-weight: bold;">${totalBoundaries}</div>
                            <div style="color: #ffffff; font-size: 0.9rem;">Total Boundaries</div>
                        </div>
                        <div>
                            <div style="color: #74b9ff; font-size: 2rem; font-weight: bold;">${avgConfidence}</div>
                            <div style="color: #ffffff; font-size: 0.9rem;">Avg Confidence</div>
                        </div>
                        <div>
                            <div style="color: #fdcb6e; font-size: 2rem; font-weight: bold;">${streak}</div>
                            <div style="color: #ffffff; font-size: 0.9rem;">Day Streak</div>
                        </div>
                    </div>
                    
                    ${totalPractices > 0 ? `
                    <div style="margin-top: 20px; text-align: center;">
                        <div style="height: 8px; background: #2d3436; border-radius: 4px; margin-bottom: 8px; overflow: hidden;">
                            <div style="height: 100%; width: ${assertivePercentage}%; background: linear-gradient(to right, #00b894, #74b9ff);"></div>
                        </div>
                        <div style="color: #ffffff; font-size: 0.9rem;">${assertivePercentage}% Assertive Responses (${assertivePractices}/${totalPractices})</div>
                    </div>
                    ` : ''}
                    
                    ${totalVisualizations > 0 ? `
                    <div style="margin-top: 20px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="color: #ffffff; margin-bottom: 10px;">Visualization Results</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div>
                                <div style="color: #00b894; font-size: 1.5rem; font-weight: bold;">${confidentCount}</div>
                                <div style="color: #ffffff; font-size: 0.8rem;">More Confident</div>
                            </div>
                            <div>
                                <div style="color: #74b9ff; font-size: 1.5rem; font-weight: bold;">${calmCount}</div>
                                <div style="color: #ffffff; font-size: 0.8rem;">Calmer</div>
                            </div>
                            <div>
                                <div style="color: #a29bfe; font-size: 1.5rem; font-weight: bold;">${reflectiveCount}</div>
                                <div style="color: #ffffff; font-size: 0.8rem;">Reflective</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="color: #74b9ff; margin: 0;">Boundary Tracking History</h4>
                    <button onclick="openTracker()" class="btn btn-sm" style="margin: 0; padding: 5px 10px; font-size: 0.9rem;">
                        + Add Entry
                    </button>
                </div>
                
                <div style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;">
                    ${progressData.length > 0 ? progressData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(entry => `
                        <div style="background: #2d3436; border-radius: 10px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #74b9ff;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="color: #74b9ff; font-weight: bold;">${entry.date}</span>
                                <div style="display: flex; gap: 15px;">
                                    <span style="color: #00b894;">üéØ ${entry.count} boundaries</span>
                                    <span style="color: #fdcb6e;">üí™ ${entry.confidence}/10 confidence</span>
                                </div>
                            </div>
                            ${entry.challenge ? `<p style="color: #ffffff; margin: 0; font-size: 0.9rem; font-style: italic;">"${entry.challenge.substring(0, 100)}${entry.challenge.length > 100 ? '...' : ''}"</p>` : ''}
                        </div>
                    `).join('') : `
                        <div style="text-align: center; color: #888; padding: 10px;">
                            <p>No boundary tracking entries yet</p>
                        </div>
                    `}
                </div>
                
                ${practiceData.length > 0 ? `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; margin-top: 20px;">
                        <h4 style="color: #74b9ff; margin: 0;">Practice Sessions</h4>
                        <button onclick="openSimulator()" class="btn btn-sm" style="margin: 0; padding: 5px 10px; font-size: 0.9rem;">
                            + New Practice
                        </button>
                    </div>
                    
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${practiceData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(session => {
                            // Set color based on response type
                            let typeColor = '#74b9ff'; // Default blue for balanced
                            let typeIcon = 'üîÑ';
                            
                            if (session.type === 'assertive') {
                                typeColor = '#00b894'; // Green
                                typeIcon = '‚úÖ';
                            } else if (session.type === 'passive') {
                                typeColor = '#fdcb6e'; // Yellow
                                typeIcon = '‚ö†Ô∏è';
                            } else if (session.type === 'aggressive') {
                                typeColor = '#e17055'; // Red
                                typeIcon = '‚ùó';
                            }
                            
                            // Format scenario name
                            const scenarioNames = {
                                'work': 'Workplace Boundary',
                                'family': 'Family Boundary',
                                'friend': 'Friendship Boundary',
                                'romantic': 'Dating Boundary',
                                'money': 'Financial Boundary'
                            };
                            
                            const scenarioName = scenarioNames[session.scenario] || 'Practice Session';
                            
                            return `
                                <div style="background: #2d3436; border-radius: 10px; padding: 12px; margin-bottom: 10px; border-left: 4px solid ${typeColor};">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <span style="color: ${typeColor}; font-weight: bold;">${typeIcon} ${session.type.charAt(0).toUpperCase() + session.type.slice(1)}</span>
                                            <div style="font-size: 0.9rem; color: #ddd; margin-top: 3px;">${scenarioName}</div>
                                        </div>
                                        <span style="color: #999; font-size: 0.9rem;">${session.date}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${visualizationData.length > 0 ? `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; margin-top: 20px;">
                        <h4 style="color: #74b9ff; margin: 0;">üßò Visualization Sessions</h4>
                        <button onclick="openConfidenceBuilder()" class="btn btn-sm" style="margin: 0; padding: 5px 10px; font-size: 0.9rem;">
                            + New Visualization
                        </button>
                    </div>
                    
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${visualizationData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(entry => {
                            // Define feeling colors and icons
                            const feelingIcons = {
                                'confident': 'üí™',
                                'calm': 'üòå',
                                'reflective': 'ü§î'
                            };
                            
                            const feelingColors = {
                                'confident': '#00b894',
                                'calm': '#74b9ff',
                                'reflective': '#a29bfe'
                            };
                            
                            const feelingLabels = {
                                'confident': 'More Confident',
                                'calm': 'Calmer',
                                'reflective': 'Reflective'
                            };
                            
                            return `
                                <div style="background: #2d3436; border-radius: 10px; padding: 12px; margin-bottom: 10px; border-left: 4px solid ${feelingColors[entry.feeling] || '#74b9ff'};">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <span style="color: ${feelingColors[entry.feeling] || '#74b9ff'}; font-weight: bold;">
                                                ${feelingIcons[entry.feeling] || '‚ú®'} ${feelingLabels[entry.feeling] || entry.feeling}
                                            </span>
                                            <div style="font-size: 0.9rem; color: #ddd; margin-top: 3px;">Guided Visualization Session</div>
                                        </div>
                                        <span style="color: #999; font-size: 0.9rem;">${entry.date}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${reflectionData.length > 0 ? `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; margin-top: 20px;">
                        <h4 style="color: #74b9ff; margin: 0;">üí≠ Daily Reflections</h4>
                        <button onclick="dailyReflection()" class="btn btn-sm" style="margin: 0; padding: 5px 10px; font-size: 0.9rem;">
                            + New Reflection
                        </button>
                    </div>
                    
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${reflectionData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(entry => {
                            // Get mood color and icon
                            const moodColors = {
                                'confident': '#00b894',
                                'frustrated': '#e17055',
                                'hopeful': '#74b9ff',
                                'overwhelmed': '#fdcb6e',
                                'proud': '#00b894',
                                'uncertain': '#a29bfe'
                            };
                            
                            const moodIcons = {
                                'confident': 'üí™',
                                'frustrated': 'üò§',
                                'hopeful': 'üåü',
                                'overwhelmed': 'üò∞',
                                'proud': 'üéâ',
                                'uncertain': 'ü§î'
                            };
                            
                            const moodLabels = {
                                'confident': 'Confident',
                                'frustrated': 'Frustrated',
                                'hopeful': 'Hopeful',
                                'overwhelmed': 'Overwhelmed',
                                'proud': 'Proud',
                                'uncertain': 'Uncertain'
                            };
                            
                            return `
                                <div style="background: #2d3436; border-radius: 10px; padding: 12px; margin-bottom: 10px; border-left: 4px solid ${moodColors[entry.mood] || '#74b9ff'};">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                                <span style="color: ${moodColors[entry.mood] || '#74b9ff'}; font-weight: bold; margin-right: 10px;">
                                                    ${moodIcons[entry.mood] || 'üí≠'} ${moodLabels[entry.mood] || entry.mood || 'Reflected'}
                                                </span>
                                                <span style="color: #74b9ff; font-size: 0.9rem;">Confidence: ${entry.confidence}/10</span>
                                            </div>
                                            ${entry.success ? `<div style="color: #00b894; font-size: 0.9rem; margin-bottom: 5px;"><strong>Success:</strong> ${entry.success.substring(0, 80)}${entry.success.length > 80 ? '...' : ''}</div>` : ''}
                                            ${entry.challenge ? `<div style="color: #fdcb6e; font-size: 0.9rem; margin-bottom: 5px;"><strong>Challenge:</strong> ${entry.challenge.substring(0, 80)}${entry.challenge.length > 80 ? '...' : ''}</div>` : ''}
                                            ${entry.goal ? `<div style="color: #a29bfe; font-size: 0.9rem;"><strong>Tomorrow's Goal:</strong> ${entry.goal.substring(0, 80)}${entry.goal.length > 80 ? '...' : ''}</div>` : ''}
                                        </div>
                                        <span style="color: #999; font-size: 0.9rem; margin-left: 10px;">${entry.date}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #2d3436 0%, #636e72 100%); border-radius: 10px;">
                        <p style="color: #ffffff; margin: 0 0 10px 0; text-align: center;">Reflection Summary</p>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; text-align: center;">
                            <div>
                                <div style="color: #74b9ff; font-size: 1.2rem; font-weight: bold;">${totalReflections}</div>
                                <div style="color: #ffffff; font-size: 0.8rem;">Total Reflections</div>
                            </div>
                            <div>
                                <div style="color: #00b894; font-size: 1.2rem; font-weight: bold;">${avgReflectionConfidence}</div>
                                <div style="color: #ffffff; font-size: 0.8rem;">Avg Confidence</div>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}
                </div>
            </div>
        `;
    }
    
    // Show modal with progress history
    showModal('üìä Your Boundary Progress History', historyContent);
}
</script>

<style>
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}
</style>
{% endblock %}